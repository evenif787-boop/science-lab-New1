<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœªæ¥ç§‘å­¦å®¶å®éªŒå®¤ Pro</title>
    <!-- å¼•å…¥ Matter.js ç‰©ç†å¼•æ“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- å…¨å±€å˜é‡ä¸é‡ç½® --- */
        :root {
            --primary: #6C5CE7;
            --secondary: #00B894;
            --accent: #FF7675;
            --dark: #2D3436;
            --light: #DFE6E9;
            --bg: #F5F6FA;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        
        body {
            margin: 0;
            font-family: 'Nunito', 'Microsoft YaHei', sans-serif;
            background: var(--bg);
            height: 100vh;
            overflow: hidden;
            display: flex;
            color: var(--dark);
        }

        /* --- å¯åŠ¨é®ç½© (ç”¨äºè§£é”éŸ³é¢‘) --- */
        #start-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(45, 52, 54, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: opacity 0.5s;
        }
        .start-btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            background: var(--secondary);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            margin-top: 20px;
            animation: pulse 2s infinite;
        }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: #636E72;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-item:hover { background: var(--bg); }
        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        /* --- ä¸»å†…å®¹åŒº --- */
        .main-stage {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .header-info {
            margin-bottom: 20px;
        }

        .module-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 25px;
            border-radius: 20px;
            border: 2px solid transparent;
            background: white;
            cursor: pointer;
            font-weight: bold;
            color: #636E72;
            transition: 0.3s;
        }

        .tab-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(108, 92, 231, 0.1);
        }

        /* --- å®éªŒåŒºåŸŸå®¹å™¨ --- */
        .lab-container {
            flex: 1;
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        /* --- å†…å®¹æ¿å— --- */
        .content-section { display: none; height: 100%; padding: 20px; animation: fadeIn 0.4s; }
        .content-section.active { display: block; }

        /* --- ç‰©ç†å¼•æ“ç”»å¸ƒ --- */
        #physics-canvas { width: 100%; height: 100%; display: block; }
        
        /* --- é€šç”¨å®éªŒæ§ä»¶ --- */
        .controls-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            backdrop-filter: blur(5px);
        }

        .btn-action {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-action:hover { transform: scale(1.1); }
        .btn-action:active { transform: scale(0.9); }

        /* --- ç°å®åº”ç”¨å¡ç‰‡ --- */
        .real-world-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        /* --- æµ‹éªŒæ ·å¼ --- */
        .quiz-box { max-width: 800px; margin: 0 auto; }
        .quiz-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid #eee;
        }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .option-btn {
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: left;
        }
        .option-btn:hover { background: #f0f0f0; }
        .option-btn.correct { background: #dff9fb; border-color: #badc58; color: #6ab04c; }
        .option-btn.wrong { background: #ffcece; border-color: #ff7675; color: #d63031; }

        /* --- åŠ¨ç”»å®šä¹‰ --- */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* åŒ–å­¦æ¨¡å—ç‰¹å®š */
        .beaker-container { 
            display: flex; justify-content: center; align-items: flex-end; height: 70%; position: relative; 
        }
        .beaker {
            width: 200px; height: 250px; border: 4px solid #dfe6e9; border-top: none; border-radius: 0 0 20px 20px;
            position: relative; overflow: hidden; background: rgba(255,255,255,0.5);
        }
        .liquid-chem {
            position: absolute; bottom: 0; width: 100%; height: 50%; background: #74b9ff; transition: background 1s;
        }
        .particle { position: absolute; border-radius: 50%; opacity: 0.7; }

    </style>
</head>
<body>

    <!-- å¯åŠ¨è¦†ç›–å±‚ -->
    <div id="start-overlay">
        <i class="fas fa-rocket fa-5x" style="color: #FFD700;"></i>
        <h1>æ¬¢è¿æ¥åˆ°æœªæ¥ç§‘å­¦å®¶å®éªŒå®¤</h1>
        <p>å‡†å¤‡å¥½æ¢ç´¢ç‰©ç†å¼•æ“å’ŒåŒ–å­¦é­”æ³•äº†å—ï¼Ÿ</p>
        <button class="start-btn" onclick="initApp()">å¼€å§‹å®éªŒ ğŸš€</button>
    </div>

    <!-- ä¾§è¾¹å¯¼èˆª -->
    <div class="sidebar">
        <div class="brand"><i class="fas fa-flask"></i> Sci-Lab Pro</div>
        <div class="nav-item active" onclick="switchModule(0)">
            <i class="fas fa-apple-alt"></i> ç‰©ç†ï¼šä¸‡æœ‰å¼•åŠ›
        </div>
        <div class="nav-item" onclick="switchModule(1)">
            <i class="fas fa-bolt"></i> ç‰©ç†ï¼šè¶£å‘³ç”µè·¯
        </div>
        <div class="nav-item" onclick="switchModule(2)">
            <i class="fas fa-vial"></i> åŒ–å­¦ï¼šé…¸ç¢±é­”æ³•
        </div>
        
        <div style="margin-top: auto; background: #f1f2f6; padding: 15px; border-radius: 10px;">
            <h4><i class="fas fa-trophy"></i> æˆ‘çš„æˆå°±</h4>
            <p>å·²å®Œæˆå®éªŒ: <span id="score-count">0</span>/3</p>
            <div style="height: 8px; background: #ddd; border-radius: 4px; margin-top:5px;">
                <div id="progress-bar" style="width: 0%; height: 100%; background: var(--secondary); border-radius: 4px; transition: width 0.5s;"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»èˆå° -->
    <div class="main-stage">
        <div class="header-info">
            <h1 id="module-title">ç‰©ç†ï¼šç‰›é¡¿çš„è‹¹æœä¸ä¸‡æœ‰å¼•åŠ›</h1>
            <p id="module-desc">åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨çœŸå®çš„ç‰©ç†å¼•æ“æ¥æ¨¡æ‹Ÿé‡åŠ›ã€ç¢°æ’å’Œå †å ï¼</p>
        </div>

        <div class="module-tabs">
            <button class="tab-btn active" onclick="switchTab('lab')"><i class="fas fa-microscope"></i> å®éªŒå®¤</button>
            <button class="tab-btn" onclick="switchTab('theory')"><i class="fas fa-book-open"></i> ç§‘å­¦åŸç†</button>
            <button class="tab-btn" onclick="switchTab('realworld')"><i class="fas fa-city"></i> ç°å®åº”ç”¨</button>
            <button class="tab-btn" onclick="switchTab('quiz')"><i class="fas fa-question-circle"></i> æŒ‘æˆ˜ç­”é¢˜</button>
        </div>

        <div class="lab-container">
            
            <!-- 1. å®éªŒå®¤è§†å›¾ -->
            <div id="view-lab" class="content-section active" style="padding: 0; position: relative;">
                <!-- ç‰©ç†å¼•æ“å®¹å™¨ -->
                <div id="physics-wrapper" style="width: 100%; height: 100%;"></div>
                
                <!-- åŒ–å­¦å®¹å™¨ -->
                <div id="chem-wrapper" style="width: 100%; height: 100%; display:none;">
                    <div class="beaker-container">
                        <div class="beaker">
                            <div class="liquid-chem" id="chem-liquid"></div>
                        </div>
                    </div>
                </div>

                <!-- ç”µè·¯å®¹å™¨ -->
                <div id="circuit-wrapper" style="width: 100%; height: 100%; display:none; position: relative; background: #34495e;">
                    <!-- ç”µè·¯å…ƒç´ å°†é€šè¿‡JSç»˜åˆ¶ -->
                    <div id="circuit-board" style="position: relative; width: 100%; height: 100%;"></div>
                </div>

                <!-- æ§åˆ¶æ  (åŠ¨æ€å†…å®¹) -->
                <div class="controls-bar" id="controls">
                    <!-- JSç”ŸæˆæŒ‰é’® -->
                </div>
            </div>

            <!-- 2. ç§‘å­¦åŸç†è§†å›¾ -->
            <div id="view-theory" class="content-section" style="overflow-y: auto;">
                <div id="theory-content" style="font-size: 1.2rem; line-height: 1.8;"></div>
            </div>

            <!-- 3. ç°å®åº”ç”¨è§†å›¾ -->
            <div id="view-realworld" class="content-section" style="overflow-y: auto;">
                <div id="realworld-content"></div>
            </div>

            <!-- 4. æµ‹éªŒè§†å›¾ -->
            <div id="view-quiz" class="content-section" style="overflow-y: auto;">
                <div class="quiz-box" id="quiz-content"></div>
            </div>

        </div>
    </div>

<script>
    // --- éŸ³æ•ˆç³»ç»Ÿ (Base64) ---
    const Sounds = {
        click: new Audio("data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="), // å ä½ï¼Œå®é™…é€»è¾‘ä¸­æ¨¡æ‹ŸçŸ­éŸ³
        pop: null,
        success: null,
        init: function() {
            // ç”Ÿæˆç®€å•çš„æŒ¯è¡å™¨éŸ³æ•ˆï¼Œæ— éœ€ä¸‹è½½æ–‡ä»¶
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        },
        playTone: function(freq, type, duration) {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + duration);
            osc.stop(this.ctx.currentTime + duration);
        },
        playClick: function() { this.playTone(600, 'sine', 0.1); },
        playPop: function() { this.playTone(400, 'triangle', 0.1); },
        playZap: function() { this.playTone(200, 'sawtooth', 0.2); },
        playSuccess: function() { 
            this.playTone(500, 'sine', 0.1);
            setTimeout(() => this.playTone(800, 'sine', 0.2), 100);
        }
    };

    // --- æ•°æ®é…ç½® ---
    const AppData = [
        {
            id: 'physics_gravity',
            title: 'ç‰©ç†ï¼šä¸‡æœ‰å¼•åŠ›ä¸ç»“æ„',
            desc: 'ä½¿ç”¨Matter.jsç‰©ç†å¼•æ“ï¼Œä½“éªŒçœŸå®çš„é‡åŠ›ã€ç¢°æ’å’Œå †å ä¹è¶£ï¼',
            theory: `
                <h3>ğŸ ä»€ä¹ˆæ˜¯ä¸‡æœ‰å¼•åŠ›ï¼Ÿ</h3>
                <p>ä»»ä½•æœ‰è´¨é‡çš„ç‰©ä½“ä¹‹é—´éƒ½æœ‰å¸å¼•åŠ›ã€‚åœ¨åœ°çƒä¸Šï¼Œåœ°çƒæ‹‰ç€æ‰€æœ‰çš„ç‰©ä½“å‘ä¸‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè‹¹æœä¼šæ‰ä¸‹æ¥ã€‚</p>
                <h3>ğŸ§± ç»“æ„ä¸å¹³è¡¡</h3>
                <p>åœ¨æ­å»ºç§¯æœ¨æ—¶ï¼Œé‡å¿ƒå¦‚æœè¶…å‡ºäº†åº•åº§çš„èŒƒå›´ï¼Œç‰©ä½“å°±ä¼šå€’å¡Œã€‚è¿™å°±æ˜¯ç‰©ç†å­¦ä¸­çš„â€œåŠ›çŸ©å¹³è¡¡â€ã€‚</p>
            `,
            realWorld: `
                <div class="real-world-card">
                    <h3>ğŸ—ï¸ å»ºç­‘å·¥ç¨‹</h3>
                    <p>å·¥ç¨‹å¸ˆåˆ©ç”¨é‡åŠ›å’Œå¹³è¡¡åŸç†å»ºé€ æ‘©å¤©å¤§æ¥¼ã€‚å¦‚æœä¸è®¡ç®—å¥½ç‰©ç†ç»“æ„ï¼Œå¤§æ¥¼å°±ä¼šåƒç§¯æœ¨ä¸€æ ·å€’å¡Œã€‚</p>
                </div>
                <div class="real-world-card" style="background: linear-gradient(135deg, #fab1a0, #e17055);">
                    <h3>ğŸ¢ è¿‡å±±è½¦</h3>
                    <p>è¿‡å±±è½¦ä»é«˜å¤„ä¿¯å†²ï¼Œåˆ©ç”¨é‡åŠ›åŠ¿èƒ½è½¬åŒ–ä¸ºåŠ¨èƒ½ï¼Œè®©æˆ‘ä»¬ä½“éªŒé£é©°ç”µæ£çš„æ„Ÿè§‰ã€‚</p>
                </div>
            `,
            quiz: [
                { q: "å¦‚æœä¸å°å¿ƒæŠŠæ¡Œå­ä¸Šçš„æ¯å­æ¨å‡ºå»ï¼Œå®ƒä¼šå»å“ªé‡Œï¼Ÿ", options: ["å¾€ä¸Šé£", "æ‰åˆ°åœ°ä¸Š", "æ‚¬åœ¨ç©ºä¸­"], ans: 1 },
                { q: "è¦æƒ³è®©ç§¯æœ¨å †å¾—é«˜ï¼Œæœ€ä¸‹é¢åº”è¯¥æ”¾ä»€ä¹ˆæ ·çš„ï¼Ÿ", options: ["æœ€å°çš„", "æœ€å¤§çš„", "åœ†å½¢çš„"], ans: 1 }
            ],
            controls: [
                { icon: 'fa-cube', action: 'spawnBox', color: '#00cec9' },
                { icon: 'fa-circle', action: 'spawnBall', color: '#fdcb6e' },
                { icon: 'fa-trash', action: 'clearWorld', color: '#d63031' }
            ]
        },
        {
            id: 'physics_circuit',
            title: 'ç‰©ç†ï¼šè¶£å‘³ç”µè·¯',
            desc: 'è¿æ¥ç”µæ± å’Œç¯æ³¡ï¼Œæ¢ç´¢ç”µæµçš„å¥¥ç§˜ï¼',
            theory: `
                <h3>âš¡ ä»€ä¹ˆæ˜¯ç”µè·¯ï¼Ÿ</h3>
                <p>ç”µè·¯å°±æ˜¯ç”µå­æµåŠ¨çš„é“è·¯ã€‚å°±åƒèµ›è½¦åœ¨èµ›é“ä¸Šè·‘ä¸€æ ·ï¼Œå¿…é¡»æ˜¯ä¸€åœˆå®Œæ•´çš„è·¯ï¼ˆé—­åˆå›è·¯ï¼‰ï¼Œè½¦æ‰èƒ½è·‘èµ·æ¥ã€‚</p>
                <h3>ğŸ”Œ å¯¼ä½“ä¸ç»ç¼˜ä½“</h3>
                <p>é‡‘å±å¯ä»¥è®©ç”µé€šè¿‡ï¼ˆå¯¼ä½“ï¼‰ï¼Œè€Œå¡‘æ–™å’Œæ©¡èƒ¶ä¸è®©ç”µé€šè¿‡ï¼ˆç»ç¼˜ä½“ï¼‰ã€‚</p>
            `,
            realWorld: `
                <div class="real-world-card" style="background: linear-gradient(135deg, #fdcb6e, #e17055);">
                    <h3>ğŸ’¡ å®¶é‡Œçš„ç¯</h3>
                    <p>æˆ‘ä»¬æŒ‰ä¸‹å¢™ä¸Šçš„å¼€å…³ï¼Œå°±æ˜¯è¿é€šäº†å¢™é‡Œçš„ç”µè·¯ï¼Œè®©ç”µå‚çš„ç”µèƒ½æµåˆ°ç¯æ³¡é‡Œã€‚</p>
                </div>
            `,
            quiz: [
                { q: "ä¸‹é¢å“ªä¸ªä¸œè¥¿å¯ä»¥å¯¼ç”µï¼Ÿ", options: ["é“é’‰", "æ©¡çš®", "æœ¨å¤´"], ans: 0 },
                { q: "å¼€å…³çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ", options: ["äº§ç”Ÿç”µ", "æ§åˆ¶ç”µè·¯é€šæ–­", "æ¶ˆè€—ç”µ"], ans: 1 }
            ],
            controls: [
                { icon: 'fa-power-off', action: 'toggleSwitch', color: '#2d3436' }
            ]
        },
        {
            id: 'chem_ph',
            title: 'åŒ–å­¦ï¼šé…¸ç¢±é­”æ³•æ°´',
            desc: 'æ»´å…¥ä¸åŒçš„æº¶æ¶²ï¼Œè§‚å¯Ÿç¥å¥‡çš„é¢œè‰²å˜åŒ–ï¼',
            theory: `
                <h3>âš—ï¸ pHå€¼æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
                <p>pHå€¼æ˜¯ç”¨æ¥æµ‹é‡æ¶²ä½“æ˜¯é…¸æ€§è¿˜æ˜¯ç¢±æ€§çš„å°ºå­ã€‚pHå€¼è¶Šå°è¶Šé…¸ï¼Œè¶Šå¤§è¶Šç¢±ã€‚</p>
                <h3>ğŸŒˆ ä¸ºä»€ä¹ˆä¼šå˜è‰²ï¼Ÿ</h3>
                <p>æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ç§å«åšâ€œèŠ±é’ç´ â€çš„æŒ‡ç¤ºå‰‚ï¼Œå®ƒé‡åˆ°é…¸ä¼šå˜çº¢ï¼Œé‡åˆ°ç¢±ä¼šå˜è“/ç»¿ã€‚ç´«ç”˜è“é‡Œå°±æœ‰å¾ˆå¤šè¿™ç§ç‰©è´¨ï¼</p>
            `,
            realWorld: `
                <div class="real-world-card" style="background: linear-gradient(135deg, #a29bfe, #6c5ce7);">
                    <h3>ğŸ§¼ è‚¥çš‚å’Œæ´—å‘æ°´</h3>
                    <p>è‚¥çš‚é€šå¸¸æ˜¯å¼±ç¢±æ€§çš„ï¼Œå¯ä»¥å»æ²¹æ±¡ã€‚è€ŒæŠ¤å‘ç´ é€šå¸¸æ˜¯å¼±é…¸æ€§çš„ï¼Œå¯ä»¥ä¿æŠ¤å¤´å‘ã€‚</p>
                </div>
                <div class="real-world-card" style="background: linear-gradient(135deg, #ffeaa7, #fab1a0);">
                    <h3>ğŸ‹ èƒƒé…¸</h3>
                    <p>æˆ‘ä»¬çš„èƒƒé‡Œæœ‰å¾ˆå¼ºçš„é…¸ï¼Œå¸®åŠ©æˆ‘ä»¬æ¶ˆåŒ–é£Ÿç‰©ï¼Œæ€ç­ç»†èŒã€‚</p>
                </div>
            `,
            quiz: [
                { q: "æŸ æª¬æ±æ˜¯ä»€ä¹ˆå‘³é“çš„ï¼Ÿå®ƒæ˜¯é…¸æ€§è¿˜æ˜¯ç¢±æ€§ï¼Ÿ", options: ["ç”œçš„/ç¢±æ€§", "é…¸çš„/é…¸æ€§", "è‹¦çš„/ä¸­æ€§"], ans: 1 },
                { q: "å¦‚æœæŒ‡ç¤ºå‰‚å˜è“äº†ï¼Œè¯´æ˜åŠ äº†ä»€ä¹ˆï¼Ÿ", options: ["è‹æ‰“æ°´(ç¢±)", "ç™½é†‹(é…¸)", "ç™½å¼€æ°´"], ans: 0 }
            ],
            controls: [
                { icon: 'fa-lemon', action: 'addAcid', color: '#e17055' },
                { icon: 'fa-soap', action: 'addBase', color: '#74b9ff' },
                { icon: 'fa-tint', action: 'resetChem', color: '#dfe6e9' }
            ]
        }
    ];

    // --- å…¨å±€çŠ¶æ€ ---
    let currentModuleIdx = 0;
    let completedModules = new Set();
    let physicsEngine = null;
    let render = null;

    // --- åˆå§‹åŒ– ---
    function initApp() {
        document.getElementById('start-overlay').style.opacity = 0;
        setTimeout(() => document.getElementById('start-overlay').style.display = 'none', 500);
        Sounds.init();
        loadModule(0);
    }

    function switchModule(idx) {
        Sounds.playClick();
        currentModuleIdx = idx;
        
        // UIæ›´æ–°
        document.querySelectorAll('.nav-item').forEach((el, i) => {
            el.classList.toggle('active', i === idx);
        });
        
        loadModule(idx);
    }

    function loadModule(idx) {
        const data = AppData[idx];
        document.getElementById('module-title').innerText = data.title;
        document.getElementById('module-desc').innerText = data.desc;
        
        // å¡«å……å†…å®¹
        document.getElementById('theory-content').innerHTML = data.theory;
        document.getElementById('realworld-content').innerHTML = data.realWorld;
        renderQuiz(data.quiz);
        renderControls(data.controls);

        // åˆ‡æ¢å›å®éªŒå®¤æ ‡ç­¾
        switchTab('lab');

        // åˆå§‹åŒ–ç‰¹å®šå®éªŒ
        stopPhysics(); // æ¸…ç†æ—§ç‰©ç†
        document.getElementById('physics-wrapper').style.display = 'none';
        document.getElementById('chem-wrapper').style.display = 'none';
        document.getElementById('circuit-wrapper').style.display = 'none';

        if (data.id === 'physics_gravity') initPhysicsLab();
        if (data.id === 'physics_circuit') initCircuitLab();
        if (data.id === 'chem_ph') initChemLab();
    }

    function switchTab(tabName) {
        Sounds.playClick();
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.closest('.tab-btn').classList.add('active'); // ç®€å•å¤„ç†ï¼Œå®é™…é¡¹ç›®ä¸­åº”ç”¨ref

        document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${tabName}`).classList.add('active');
    }

    // --- æ¸²æŸ“æ§ä»¶ ---
    function renderControls(controls) {
        const bar = document.getElementById('controls');
        bar.innerHTML = '';
        controls.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'btn-action';
            btn.style.background = c.color;
            btn.innerHTML = `<i class="fas ${c.icon}"></i>`;
            btn.onclick = () => handleAction(c.action);
            bar.appendChild(btn);
        });
    }

    // --- åŠ¨ä½œåˆ†å‘ä¸­å¿ƒ ---
    function handleAction(action) {
        Sounds.playClick();
        
        // ç‰©ç†å¼•æ“åŠ¨ä½œ
        if (action === 'spawnBox') spawnBody('box');
        if (action === 'spawnBall') spawnBody('circle');
        if (action === 'clearWorld') clearPhysics();

        // ç”µè·¯åŠ¨ä½œ
        if (action === 'toggleSwitch') toggleCircuit();

        // åŒ–å­¦åŠ¨ä½œ
        if (action === 'addAcid') changePh('acid');
        if (action === 'addBase') changePh('base');
        if (action === 'resetChem') changePh('reset');
    }

    // ==========================================
    // æ¨¡å— 1: Matter.js ç‰©ç†å¼•æ“é›†æˆ
    // ==========================================
    function initPhysicsLab() {
        const container = document.getElementById('physics-wrapper');
        container.style.display = 'block';

        // æ¨¡å—åˆ«å
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Mouse = Matter.Mouse,
              MouseConstraint = Matter.MouseConstraint;

        // åˆ›å»ºå¼•æ“
        physicsEngine = Engine.create();
        const world = physicsEngine.world;

        // åˆ›å»ºæ¸²æŸ“å™¨
        render = Render.create({
            element: container,
            engine: physicsEngine,
            options: {
                width: container.offsetWidth,
                height: container.offsetHeight,
                background: 'transparent',
                wireframes: false
            }
        });

        // è¾¹ç•Œ
        const ground = Bodies.rectangle(container.offsetWidth/2, container.offsetHeight, container.offsetWidth, 60, { isStatic: true, render: { fillStyle: '#2d3436' } });
        const leftWall = Bodies.rectangle(0, container.offsetHeight/2, 60, container.offsetHeight, { isStatic: true, render: { visible: false } });
        const rightWall = Bodies.rectangle(container.offsetWidth, container.offsetHeight/2, 60, container.offsetHeight, { isStatic: true, render: { visible: false } });
        
        Composite.add(world, [ground, leftWall, rightWall]);

        // é¼ æ ‡äº¤äº’
        const mouse = Mouse.create(render.canvas);
        const mouseConstraint = MouseConstraint.create(physicsEngine, {
            mouse: mouse,
            constraint: { stiffness: 0.2, render: { visible: false } }
        });
        Composite.add(world, mouseConstraint);
        render.mouse = mouse;

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, physicsEngine);
        physicsEngine.runner = runner; // å­˜å‚¨å¼•ç”¨ä»¥ä¾¿æ¸…ç†
    }

    function spawnBody(type) {
        if (!physicsEngine) return;
        Sounds.playPop();
        const x = Math.random() * 400 + 100;
        const y = 50;
        let body;
        
        if (type === 'box') {
            body = Matter.Bodies.rectangle(x, y, 60, 60, { 
                restitution: 0.5,
                render: { fillStyle: '#00cec9' } 
            });
        } else {
            body = Matter.Bodies.circle(x, y, 30, { 
                restitution: 0.8,
                render: { fillStyle: '#fdcb6e' } 
            });
        }
        Matter.Composite.add(physicsEngine.world, body);
    }

    function clearPhysics() {
        if (!physicsEngine) return;
        Matter.Composite.clear(physicsEngine.world, false);
        // é‡æ–°æ·»åŠ è¾¹ç•Œ (ç®€å•å¤„ç†ï¼šé‡æ–°åˆå§‹åŒ–)
        stopPhysics();
        initPhysicsLab();
    }

    function stopPhysics() {
        if (physicsEngine) {
            Matter.Render.stop(render);
            Matter.Runner.stop(physicsEngine.runner);
            render.canvas.remove();
            render.canvas = null;
            render.context = null;
            render.textures = {};
            physicsEngine = null;
        }
    }

    // ==========================================
    // æ¨¡å— 2: ç”µè·¯æ¨¡æ‹Ÿ (åŸç”ŸCanvasç»˜åˆ¶)
    // ==========================================
    let isCircuitOn = false;
    
    function initCircuitLab() {
        const wrapper = document.getElementById('circuit-wrapper');
        wrapper.style.display = 'block';
        const board = document.getElementById('circuit-board');
        
        // ç®€å•èµ·è§ï¼Œä½¿ç”¨HTMLç»“æ„æ¨¡æ‹Ÿï¼Œæ¯”Canvasæ›´å®¹æ˜“äº¤äº’
        board.innerHTML = `
            <div style="position:absolute; top:20%; left:10%; font-size:3rem; color:#d63031;"><i class="fas fa-battery-full"></i></div>
            <div id="bulb-icon" style="position:absolute; top:20%; right:15%; font-size:4rem; color:#b2bec3; transition:0.3s;"><i class="fas fa-lightbulb"></i></div>
            <div id="switch-icon" style="position:absolute; bottom:20%; left:45%; font-size:3rem; color:#636e72; transform: rotate(-30deg); transition:0.3s;"><i class="fas fa-toggle-off"></i></div>
            
            <!-- å¯¼çº¿ (SVG) -->
            <svg width="100%" height="100%" style="position:absolute; top:0; pointer-events:none;">
                <path d="M 100 150 L 100 50 L 600 50 L 600 150" stroke="#95a5a6" stroke-width="5" fill="none" />
                <path d="M 100 200 L 100 350 L 350 350" stroke="#95a5a6" stroke-width="5" fill="none" />
                <path d="M 600 250 L 600 350 L 450 350" stroke="#95a5a6" stroke-width="5" fill="none" />
            </svg>
        `;
        isCircuitOn = false;
    }

    function toggleCircuit() {
        isCircuitOn = !isCircuitOn;
        const bulb = document.getElementById('bulb-icon');
        const sw = document.getElementById('switch-icon');
        
        if(isCircuitOn) {
            Sounds.playZap();
            bulb.style.color = '#f1c40f';
            bulb.style.textShadow = '0 0 30px #f1c40f';
            sw.style.transform = 'rotate(0deg)';
            sw.style.color = '#2d3436';
            sw.innerHTML = '<i class="fas fa-toggle-on"></i>';
        } else {
            bulb.style.color = '#b2bec3';
            bulb.style.textShadow = 'none';
            sw.style.transform = 'rotate(-30deg)';
            sw.style.color = '#636e72';
            sw.innerHTML = '<i class="fas fa-toggle-off"></i>';
        }
    }

    // ==========================================
    // æ¨¡å— 3: åŒ–å­¦æ¨¡æ‹Ÿ
    // ==========================================
    function initChemLab() {
        document.getElementById('chem-wrapper').style.display = 'block';
        document.getElementById('chem-liquid').style.background = '#74b9ff'; // ä¸­æ€§
        document.getElementById('chem-liquid').style.height = '50%';
    }

    function changePh(type) {
        const liquid = document.getElementById('chem-liquid');
        if (type === 'acid') {
            Sounds.playPop();
            liquid.style.background = '#ff7675'; // å˜çº¢
            liquid.style.height = '60%';
            createBubbles();
        } else if (type === 'base') {
            Sounds.playPop();
            liquid.style.background = '#6c5ce7'; // å˜è“
            liquid.style.height = '60%';
            createBubbles();
        } else {
            liquid.style.background = '#74b9ff';
            liquid.style.height = '50%';
        }
    }

    function createBubbles() {
        const beaker = document.querySelector('.beaker');
        for(let i=0; i<5; i++) {
            const b = document.createElement('div');
            b.className = 'particle';
            b.style.width = Math.random()*10 + 5 + 'px';
            b.style.height = b.style.width;
            b.style.background = 'rgba(255,255,255,0.6)';
            b.style.left = Math.random()*150 + 20 + 'px';
            b.style.bottom = '0';
            beaker.appendChild(b);

            // ç®€å•çš„æ°”æ³¡ä¸Šå‡åŠ¨ç”»é€»è¾‘
            let pos = 0;
            const anim = setInterval(() => {
                pos += 2;
                b.style.bottom = pos + 'px';
                if(pos > 200) {
                    clearInterval(anim);
                    b.remove();
                }
            }, 20);
        }
    }

    // ==========================================
    // æµ‹éªŒä¸æˆå°±ç³»ç»Ÿ
    // ==========================================
    function renderQuiz(questions) {
        const container = document.getElementById('quiz-content');
        container.innerHTML = '';
        
        questions.forEach((q, idx) => {
            const item = document.createElement('div');
            item.className = 'quiz-item';
            
            let optionsHtml = '';
            q.options.forEach((opt, optIdx) => {
                optionsHtml += `<button class="option-btn" onclick="checkAnswer(this, ${optIdx}, ${q.ans}, ${idx})">${opt}</button>`;
            });

            item.innerHTML = `
                <h3>â“ é—®é¢˜ ${idx+1}: ${q.q}</h3>
                <div class="quiz-options">${optionsHtml}</div>
                <div class="result-msg" style="margin-top:10px; font-weight:bold;"></div>
            `;
            container.appendChild(item);
        });
    }

    function checkAnswer(btn, selected, correct, qIdx) {
        const parent = btn.parentElement;
        const msg = parent.nextElementSibling;
        
        // ç¦ç”¨è¯¥é¢˜æ‰€æœ‰æŒ‰é’®
        const allBtns = parent.querySelectorAll('.option-btn');
        allBtns.forEach(b => b.disabled = true);

        if (selected === correct) {
            btn.classList.add('correct');
            msg.innerHTML = "âœ… å›ç­”æ­£ç¡®ï¼å¤ªæ£’äº†ï¼";
            msg.style.color = "#27ae60";
            Sounds.playSuccess();
            updateProgress();
        } else {
            btn.classList.add('wrong');
            // é«˜äº®æ­£ç¡®ç­”æ¡ˆ
            allBtns[correct].classList.add('correct');
            msg.innerHTML = "âŒ å“å‘€ï¼Œç­”é”™äº†ã€‚å†æ¥å†å‰ï¼";
            msg.style.color = "#c0392b";
        }
    }

    function updateProgress() {
        // ç®€å•çš„è¿›åº¦é€»è¾‘ï¼šæ¯ç­”å¯¹ä¸€ä¸ªé—®é¢˜å°±ç®—ä¸€ç‚¹ï¼ˆå®é™…åº”è¯¥æ›´å¤æ‚ï¼‰
        // è¿™é‡Œæ¼”ç¤ºå®Œæˆä¸€ä¸ªæ¨¡å—
        completedModules.add(currentModuleIdx);
        const count = completedModules.size;
        document.getElementById('score-count').innerText = count;
        document.getElementById('progress-bar').style.width = (count / 3 * 100) + '%';

        if (count === 3) {
            // å…¨é€šå…³ç‰¹æ•ˆï¼Œå¯ä»¥åŠ confetti
            setTimeout(() => alert("ğŸ‰ æ­å–œä½ æˆä¸ºäº†å°å°ç§‘å­¦å®¶å¤§å¸ˆï¼"), 500);
        }
    }

</script>
</body>
</html>